<h2 id='overview'> Overview </h2>
<p>
  This guide is meant to supplement the live tutorial given by Andrew Cumming and Bill Wolf at the
  <a href="http://www.lorentzcenter.nl/lc/web/2019/1174/info.php3?wsid=1174&venue=Snellius" target=_blank>
    Bursting the Bubble
  </a>
  workshop hosted at
  <a href="http://www.lorentzcenter.nl" target=_blank>
    the Lorentz Center
  </a>
  at the
  <a href="www.leiden.edu" target=_blank>
    Leiden University
  </a> in June 2019. Here, we'll help new users of Modules for Experiments in Stellar Astrophysics (<samp>MESA</samp>) get started with the tool to model thermonuclear bursts on white dwarfs and neutron stars. We'll leave this tutorial online for at least awhile afterwards in the hopes that it proves to be a helpful guide for getting started with bursts in <samp>MESA</samp>, but these instructions are aimed at participants going through the tutorial at the workshop. It will likely fall out of date as the interface of <samp>MESA</samp> changes in its development and the hyperlinks on this page become outdated.
</p>
<p>
  You should complete Part 0 before the tutorial begins on Tuesday afternoon. If you have issues, reach out to Andrew on Monday to get set up in advance of the tutorial.
</p>
<p>
  Throughout this page, monospaced text on a black background, like this: <kbd>echo "Hello, World!"</kbd> represent commands you can type into your terminal and execute, while red monospaced text like this: <code>mass_change = 1d-9</code> represent file names or values that you might type into a file, but not something to be executed.
</p>

<h2 id='part0' class='mt-5'>Part 0: Before You Arrive</h2>
<p>
  Installing <samp>MESA</samp> and its prerequisites is not particularly difficult for most users and systems, but it can take a little time to download and compile, so you should do this before the tutorial, and ideally early enough so that you can ask Andrew for help on Monday. 
</p>
<h4 id="part0a" class='mt-4'>Installing the SDK</h4>
<p>
  While <samp>MESA</samp> can be run on custom compilers and other tools with a fair amount of work, the <samp>MESA</samp> SDK is the easiest way to get started. Get the SDK with the link below, and follow the instructions for your particular system, noting the prerequsites.
</p>
<p class='text-center'>
  <a href="http://www.astro.wisc.edu/~townsend/static.php?ref=mesasdk" class="btn btn-lg btn-primary" target=_blank>Get the MESA SDK</a>
</p>
<p>
  Your first step is to install the SDK and confirm that it works on your system by trying <code>which gfortran</code> in a terminal to confirm that the SDK version of gfortran is being used.
</p>
<div class="card border-warning mb-3 text-warning">
  <div class="card-header bg-warning text-white">
    <h5 class='card-title mb-0'>Warning for macOS Mojave Users</h5>
  </div>
  <div class="card-body">
    <p class="card-text">
      On macOS 10.14 (Mojave; and perhaps later versions, too), you may also need to install the development header files. These ship as a standard part of Mojave, but must be installed by hand. To do so, run the command
    </p>
    <p class='card-text'>
      <code>
open /Library/Developer/CommandLineTools/Packages/macOS_SDK_headers_for_macOS_10.14.pkg
      </code>
    </p>
    <p class='card-text'>
      This step may need to be repeated whenever you upgrade to a new release of the Xcode command-line tools.
    </p>
  </div>
</div>

<h4 id="part0b" class='mt-4'>Installing <samp>MESA</samp></h4>
<p>
  Once the SDK is properly installed, it's time to install <samp>MESA</samp> on your machine. This amounts to downloading a zip file, moving it to where you want, and executing an install script.
</p>
<p class='text-center'>
  <a href="http://mesa.sourceforge.net/prereqs.html#download-mesa" target=_blank class='btn btn-lg btn-primary'>Get MESA</a>
</p>
<h4 id="part0c" class='mt-4'>Your First MESA Run</h4>
<p>
  With <samp>MESA</samp> and its SDK installed, it's time to do a first run to make sure eveything is working properly. Follow the official tutorial and feel free to play around a bit once you've gotten the hang of it!
</p>
<p class='text-center'>
  <a href="http://mesa.sourceforge.net/starting.html#how-do-you-get-started-using-mesa-star" target=_blank class="btn btn-primary btn-lg">Getting Started with MESA</a>
</p>
<p>
  In that simple exercise, you learned how to create a new simulation in <samp>MESA</samp>. You then went into this new work directory, compiled it, and ran it. We now summarize these steps, as they are the most common path to creating a new simulation:
</p>
<ol>
  <li>Make new work directory: <code>cp -r $MESA_DIR/star/work tutorial</code></li>
  <li>Enter that directory: <code>cd tutorial</code></li>
  <li>Compile the work directory: <code>./mk</code></li>
  <li>Start the simulation: <code>./rn</code></li>
</ol>

<div class="card border-secondary mb-3">
  <div class="card-header bg-secondary">
    <h5 class='card-title mb-0'><samp>MESA</samp> Best Practice: Work Directories</h5>
  </div>
  <div class="card-body">
    <p class='card-text'>
      Never run simulations from within your local installation of <samp>MESA</samp>. Depending on the value of <code>$MESA_DIR</code> is, you may not actually be compiling against the installation you think you are, and in general it's best to not mess with the source code.
    </p>
    <p class='card-text'>
      Instead, always make a copy of the standard work directory <code>$MESA_DIR/star/work</code> or start from one of the test cases in <code>$MESA_DIR/star/test_suite</code> (though those require a bit of work to be truly customized).
    </p>
  </div>
</div>
<p> 
  You also should have learned a little about the inlist files that control the simulation as well as how to start a simulation (<kbd>./rn</kbd>) and restart from a photo (<kbd>./re <var>photo</var></kbd>, where <var>photo</var> is one of the files in the <code>photos</code> directory). Confirm that you know how to do all these things, and that you saw the terminal output and real-time plots indicated in the "gettings started" tutorial as you ran the simulation before moving on.
</p>

<p>
  If you're looking for a more in-depth tutorial into general use of <samp>MESA</samp> that will really prepare you for our work with bursts, <a href="https://yoshiyahu.org" target=_blank>Josiah Schwab</a> has prepared a great introduction to using inlists and much more for the <samp>MESA</samp> summer school.
</p>

<p class='text-center'>
  <a href="https://jschwab.github.io/mesa-2018/#orgbd38b04" target=_blank class="btn btn-lg btn-primary">
    [Optional] Go Deeper with MESA
  </a>
</p>

<h2 id="part1" class='mt-5'> Part 1: MESA Basics </h2>
<p>
  <samp>MESA</samp> is a <strong>modular</strong> code, so different parts of the code handle different tasks needed in modeling stars. Most often, you'll be using the <code>star</code> module, which uses the other modules to compute a stellar model and evolve it in time. Let's take a look at the structure of a typical work directory.
</p>
<h4 id="part1a" class='mt-4'>Structure of a Work Directory</h4>
<p>
  Your tutorial work directory had the following files and directories. Click on each to learn about what each file or directory does.
</p>
<div class="row" id="workdir-files">
  <div class="col-md-3">
    <div class="list-group info-toggle" data-target="#file-description">
      <a href="#part1a" class="list-group-item list-group-item-action active" data-name="inlist" data-description="Instructions for how to model the star, including models to load, timestep controls, microphysics options, and on-screen plots. Often this punts to other inlist files to separate different functionalities.">
        inlist
      </a>
      <a href="#part1a" class="list-group-item list-group-item-action" data-name="inlist_project" data-description="Another inlist that <code>inlist</code> points to. The name isn't special; it just matches what extra inlist is loaded by <code>inlist</code>. This one controls all aspects of the model except on-screen plots.">inlist_project</a>
      <a href="#part1a" class="list-group-item list-group-item-action"data-name="inlist_pgstar" data-description="Another inlist that <code>inlist</code> points to. The name isn't special; it just matches what extra inlist is loaded by <code>inlist</code>. This one only controls on-screen plots.">inlist_pgstar</a>
      <a href="#part1a" class="list-group-item list-group-item-action" data-name="mk" data-description="Executable script that recompiles the local copy of <code>star</code>. You only need to execute this if you make changes to files in the <code>src</code> directory or upgrade <samp>MESA</samp>.">mk</a>
      <a href="#part1a" class="list-group-item list-group-item-action" data-name="rn" data-description="Executable that, after compilation with <code>mk</code> starts the simulation defined by <code>inlist</code> and any custom code in <code>src/run_star_extras.f</code>.">rn</a>
      <a href="#part1a" class="list-group-item list-group-item-action" data-name="re" data-description="Executable that restarts an interrupted or completed run from an earlier photo. It takes one argument, which is a photo file found in the <code>photos</code> directory.">re</a>
      
    </div>
  </div>
  <div class="col-md-3">
    <div class="list-group info-toggle" data-target="#file-description">
      <a href="#part1a" class="list-group-item list-group-item-action" data-name="clean" data-description="Executable that resets the compilation process done by <code>mk</code>. Typically only needed if you are running a simulation that was previously compiled by a different version of the SDK or from an older version of <samp>MESA</samp>">
        clean
      </a>
      <a href="#part1a" class="list-group-item list-group-item-action" data-name="star" data-description="The actual executable that evolves the stellar model. Usually this is wrapped by <code>rn</code> and <code>re</code>. You should almost never call it directly.">star</a>
      <a href="#part1a" class="list-group-item list-group-item-action"data-name="LOGS" data-description="Directory that holds all data from a run in history and profile files. These are stored in plain text. The name of this directory, how often the data is recorded, and what data is recorded are all customizable in the inlists and other files.">LOGS</a>
      <a href="#part1a" class="list-group-item list-group-item-action" data-name="photos" data-description="Directory that holds snapshots of the simulation stored in binary. These are used to restart the simulation, but they are <strong>not</strong> for long-term storage of the model, as their format changes from version to version.">photos</a>
      <a href="#part1a" class="list-group-item list-group-item-action" data-name="src" data-description="Directory that contains source code for the executable built by <code>mk</code>. Most is just read in from the main <code>MESA_DIR</code>, but you can add your own code to <code>run_star_extras.f</code>.">src</a>
      <a href="#part1a" class="list-group-item list-group-item-action" data-name="make" data-description="Directory that contains the makefile and byproducts of the compilation process. You rarely need to fiddle with this.">make</a>
      
    </div>
  </div>
  <div class="col-md-6">
    <div class="card" id='file-description'>
      <div class="card-header bg-primary text-white">
        <samp class='name'>inlist</samp>
      </div>
      <div class="card-body">
        <p class='card-text description'>
          Instructions for how to model the star, including models to load, timestep controls, microphysics options, and on-screen plots. Often this punts to other inlist files to separate different functionalities.
        </p>
      </div>
    </div>
  </div>
</div>

<h4 id='part1b' class='mt-4'>MESA Output</h4>
<p>
  Output from a <samp>MESA</samp> simulation is stored in the <code>LOGS</code> directory (though you can change the name of this directory in the inlist). There are two primary types of output files: histories and profiles. Each simulation has one history file, typically called <code>history.data</code>, that records how scalar quantites related to the model like age and luminosity change through time. There can be many profiles saved, and each file gives a snapshot of quantities that vary throughout the entire star, like density and temperature. There is one other file, called <code>profiles.index</code>. This file relates the names of profiles to their corresponding model number (timestep) in the history file.
</p>

<p>
  How often profiles are written to disk, how many there are allowed to be before they start to get overwritten (they can get quite large!), how often a line is recorded in the history file, how the files are named, and many other output details can be customized in the inlist. The exact types of data that are recorded in the history and profiles are controlled in two other files that may or may not be in your work directory: <code>history_columns.list</code> and <code>profile_columns.list</code>. If these files do not exist in your work directory, they are read from their default location in <code>$MESA_DIR/star/defaults</code>.
</p>

<p>
  To enable/disable different columns in the output files, open the corresponding columns file and uncomment the names of columns you want to output, and comment out those that you don't.
</p>

<div class="card border-secondary mb-3">
  <div class="card-header bg-secondary">
    <h5 class='card-title mb-0'>
      <samp>MESA</samp> Best Practice: Output Column Files
    </h5>
  </div>
  <div class="card-body">
    <p>
      Don't edit the default columns files so that you don't get unexpected behavior in other projects. Instead, copy them into your local work directory via

      <p><kbd>cp $MESA_DIR/star/defaults/history_columns.list PATH/TO/WORK_DIR/</kbd></p>
      <p><kbd>cp $MESA_DIR/star/defaults/profile_columns.list PATH/TO/WORK_DIR/</kbd></p>
    </p>
    <p>
      Then, edit these files in your local work directory. <samp>MESA</samp> will always look for these files in the local directory before falling back to their default versions.
    </p>
  </div>
</div>
<p>
  You can see a summary of each of the important files for <samp>MESA</samp> output by clicking on each of them below
</p>
<div class="row" id="output-files" style="min-height: 20em;">
  <div class="col-md-4">
    <h5>Files in <code>LOGS</code></h5>
    <div class="list-group info-toggle" data-target='#output-description'>
      <a href="#part1b" class="list-group-item list-group-item-action active" data-name="history.data" data-description="Data file with each line giving data for a model number/timestep. The columns used are determined by the uncommented lines in <code>history_columns.list</code>. You can set the frequency for outputting a line with the <code>history_interval</code> control in the <code>controls</code> namelist.">
        history.data
      </a>
      <a href="#part1b" class="list-group-item list-group-item-action" data-name="profilexx.data" data-description="Data file with one line for each cell/zone in the stellar model at a particular timestep. The columns of data that are determined by the uncommented lines in <code>profile_columns.list</code>. You can set the frequency for outputting a new profile with the <code>profile_interval</code> control in the <code>controls</code> namelist. The number of profiles saved before overwriting older profiles is set by the <code>max_num_profile_models</code> command in the <code>controls</code> namelist.">profilexx.data</a>
      <a href="#part1b" class="list-group-item list-group-item-action"data-name="profiles.index" data-description="Contains columns that give the model numbers and priorities (higher priority means less likely to be overwritten) for each profile. This allows you to map profile numbers (the <var>xx</var> in file <code>profilexx.data</code>, <strong>which may be non-monotonic in time</strong>, with model numbers, and thus is the key to relate profiles with lines in the history file.">profiles.index</a>
    </div>
    <h5 style="padding-top: 1em;">Optional in Work Dir</h5>
    <div class="list-group info-toggle" data-target='#output-description'>
      <a href="#part1b" class="list-group-item list-group-item-action" data-name="history_columns.list" data-description="A list of quantities that can be output in <code>history.data</code>. If you don't have this file, the default version in <code>$MESA_DIR/star/defaults</code> will be read. Uncomment lines to enable reporting of quantities, and comment them out to disable them. This file also controls what quantities can be plotted in on-screen history plots.">
        history_columns.list
      </a>
      <a href="#part1b" class="list-group-item list-group-item-action" data-name="profile_columns.list" data-description="A list of quantities that can be output in profile files. If you don't have this file, the default version in <code>$MESA_DIR/star/defaults</code> will be read. Uncomment lines to enable reporting of quantities, and comment them out to disable them.">
        profile_columns.list
      </a>
    </div>
  </div>
  <div class="col-md-8 vcenter">
    <div class="card" id='output-description'>
      <div class="card-header bg-primary text-white">
        <samp class='name'>history.data</samp>
      </div>
      <div class="card-body">
        <p class='card-text description'>
          Data file with one line for each model number/timestep (or every <var>n</var> models. The columns used are determined by the uncommented lines in <code>history_columns.list</code>. You can set the frequency for outputting a line with the <code>history_interval</code> control in the <code>controls</code> namelist.
        </p>
      </div>
    </div>
  </div>
</div>
<p style="padding-top: 20px;">
  The main <samp>MESA</samp> website has suggestions for how to work with MESA output, including a recommended python library for reading and plotting it after the simulation is over.
</p>
<p class='text-center'>
  <a href="http://mesa.sourceforge.net/output.html" target=_blank class='btn btn-lg btn-primary'>
    Learn More About Output
  </a>
</p>

<h4 id='part1c' class='mt-4'>Working with Inlists</h4>
<p>
  When you execute <kbd>./rn</kbd> or <kbd>./re <var>photo</var></kbd> in a vanilla work directory, <samp>MESA</samp> reads instructions from <code>inlist</code>. The name of the file <em>must</em> be "inlist". The inlist is composed of three <em>namelists</em>, which are series of name-value pairs, set off at the top by <code>&<var>namelist</var></code> where <var>namelist</var> is the name of the namelist, and concluded by a line with a single slash: <code>/</code>. See for example, the contents of <code>inlist</code> from the initial tutorial.
</p>
<h5>Contents of <code>inlist</code></h5>
{% highlight fortran %}
! this is the master inlist that MESA reads when it starts.

! This file tells MESA to go look elsewhere for its configuration
! info. This makes changing between different inlists easier, by
! allowing you to easily change the name of the file that gets read.

&star_job

    read_extra_star_job_inlist1 = .true.
    extra_star_job_inlist1_name = 'inlist_project'

/ ! end of star_job namelist


&controls

    read_extra_controls_inlist1 = .true.
    extra_controls_inlist1_name = 'inlist_project'

/ ! end of controls namelist


&pgstar

    read_extra_pgstar_inlist1 = .true.
    extra_pgstar_inlist1_name = 'inlist_pgstar'

/ ! end of pgstar namelist
{% endhighlight %}
<p>
  In <samp>MESA star</samp>, there are three types of namelists, and all three are in this example inlist. Click through each namelist below to learn what each is used for. You can also find documentation for each namelist on the <a href="http://mesa.sourceforge.net" target=_blank><samp>MESA</samp> home page</a> that is automatically generated from the defaults files. 
</p>
<div class="row" id="namelists" style="min-height: 15em">
  <div class="col-md-3">
    <div class="list-group info-toggle" data-target='#namelist-description'>
      <a href="#part1c" class="list-group-item list-group-item-action active" data-name="star_job" data-description="Contains controls for the program that evolves the star. For instance, whether or not the program should load a model or save one. Also tells the program where to find opacity and eos tables, what nuclear network to use, and other fundamental options that deal with modules outside of <samp>star</samp>. Defaults values and documentation for options are found in <code>$MESA_DIR/star/defaults/star_job.defaults</code>.">
        star_job
      </a>
      <a href="#part1c" class="list-group-item list-group-item-action" data-name="controls" data-description="Sets parameters relevant to the <samp>star</samp> module. These are more specific instructions on how the model should proceed. The initial mass, assumptions for how convection should work, how often profiles should be output, and when the program should stop are all set here. Default values and documentation for options are found in <code>$MESA_DIR/star/defaults/controls.defaults</samp>.">
        controls
      </a>
      <a href="#part1c" class="list-group-item list-group-item-action"data-name="pgstar" data-description="Controls on-screen plots during the run of the program, including saving them as png files. We won't cover this here, but see the information in <code>pgstar.README</code> and <code>pgstar.defaults</code>, in <code>$MESA_DIR/star/defaults</code>. Also see the <a href='https://youtu.be/8vFfM2f46yw' target=_blank>tutorial from Frank Timmes</a>, which walks you through a rich example. Just be sure to use the <a href='http://cococubed.asu.edu/mesa_market/education.html' target=_blank>most updated work directory available</a> if you play along.">
        pgstar
      </a>
    </div>
  </div>
  <div class="col-md-9">
    <div class="card" id='namelist-description'>
      <div class="card-header bg-primary text-white">
        <samp class='name'>star_job</samp>
      </div>
      <div class="card-body">
        <p class='card-text description'>
          Contains controls for the program that evolves the star. For instance, whether or not the program should load a model or save one. Also tells the program where to find opacity and eos tables, what nuclear network to use, and other fundamental options. Defaults are found in <code>$MESA_DIR/star/defaults/star_job.defaults</code>.
        </p>
      </div>
    </div>
  </div>
</div>
<p>
  In this case, each namelist only has two controls set. The first tells the namelist to read values from another file, which must also be set up in this way. The second tells it the name of the file to read in.
</p>

<div class="card border-seconary mb-3">
  <div class="card-header bg-seconary">
    <h5 class='card-title mb-0'><samp>MESA</samp> Best Practice: Multiple Inlists</h5>
  </div>
  <div class="card-body">
    <p class='card-text'>
      It may seem needlessly complicated to have inlists pointing to each other instead of putting all controls in one inlist, but this is often very convenient, since large inlists can become cumbersome.
    </p>
    <p class='card-text'>
      A common convention is to have a "favorites" list in an inlist, named something like <code>inlist_common</code>. Here you have your preferred default settings. Then in another inlist, you put the truly unique quantities that differentiate this simulation from others.
    </p>
    <p class='card-text'>
      pgstar namelists can also become quite lengthy, so it is extremely common to see them broke out into their own file, typically called <code>inlist_pgstar</code>.
    </p>
    <p class='card-text'>
      There's nothing stopping you from just having one giant inlist with all of your controls, though!
    </p>
  </div>
</div>
<p>
  For completeness, let's look at the contents of <code>inlist_project</code> to see some more typical namelists.
</p>
<h5>Contents of <code>inlist_project</code></h5>
{% highlight fortran %}
! inlist to evolve a 15 solar mass star

! For the sake of future readers of this file (yourself included),
! ONLY include the controls you are actually using.  DO NOT include
! all of the other controls that simply have their default values.

&star_job

  ! begin with a pre-main sequence model
    create_pre_main_sequence_model = .true.

  ! save a model at the end of the run
    save_model_when_terminate = .false.
    save_model_filename = '15M_at_TAMS.mod'

  ! display on-screen plots
    pgstar_flag = .true.

/ !end of star_job namelist


&controls

  ! starting specifications
    initial_mass = 15 ! in Msun units

  ! options for energy conservation (see MESA V, Section 3)
     use_dedt_form_of_energy_eqn = .true.
     use_gold_tolerances = .true.

  ! stop when the star nears ZAMS (Lnuc/L > 0.99)
    Lnuc_div_L_zams_limit = 0.99d0
    stop_near_zams = .true.

  ! stop when the center mass fraction of h1 drops below this limit
    xa_central_lower_limit_species(1) = 'h1'
    xa_central_lower_limit(1) = 1d-3

/ ! end of controls namelist
{% endhighlight %}
<p>
  Note here that there are only two namelists (<code>pgstar</code> is relegated to <code>inlist_pgstar</code>). If you are unfamiliar with fortran syntax, note also the literals for booleans, <code>.true.</code> and <code>.false.</code> as well as how array assignment works, as in <code>xa_central_lower_limit(1) = 1d-3</code>
</p>

<div class="card border-warning mb-3 text-warning">
  <div class="card-header bg-warning text-white">
    <h5 class='card-title mb-0'>Warning: Inlist Pitfalls</h5>
  </div>
  <div class="card-body">
    <p class="card-text">
      The syntax of inlists is somewhat strict. While whitespace doesn't matter, please observe the following rules to avoid sadness.
    </p>
    <ul>
      <li>
        Don't use any mathematical operators in values, only literals (strings, floats, integers, and logicals).
      </li>
      <li>
        Don't use control statements like <code>if</code> or <code>while</code>
      </li>
      <li>
        Always use double precision numbers for floats, as in <code>1d3</code> rather than <code>1000.0</code> or <code>1e3</code>
      </li>
      <li>
        Put controls in their correct namelists. Capitalizaition is not important, but spelling is.
      </li>
    </ul>
    <p class="card-text">Some of these shortcomings can be mitigated by using a third-party tool, <a href="http://wmwolf.github.io/MesaScript/" target=_blank>MesaScript</a>, but this is beyond the scope of this tutorial.
    </p>
  </div>
</div>

<h4 id="part1d" class='mt-4'>Compiling, Running, and Restarting</h4>
<p>
  So you have set up a new work directory, edited your inlists with controls found in <code>$MESA_DIR/star/defaults</code>, and you're ready to run your model. First, you need to compile!
</p>
<h5>Compiling and Troubleshooting</h5>
<p>
  To compile your code, execute <kbd>./mk</kbd>. You should see a few lines fly by on your terminal, and hopefully no errors. If you do have errors, check the following:
</p>
<ul>
  <li>
    Make sure you have <code>$MESASDK_ROOT</code> set up via <kbd>echo $MESASDK_ROOT</kbd>
  </li>
  <li>
    Make sure the SDK is initialized. A quick indication that this is fine is to run <kbd>which gfortran</kbd> and making sure the resulting path points to the gfortran in the SDK.
  </li>
  <li>
    If you've made edits to <code>src/run_star_extras.f</code> (more on this later), check the error output for indications that you have bugs in your code.
  </li>
  <li>
    Try first running <kbd>./clean</kbd> and then do <kbd>./mk</kbd>
  </li>
  <li>
    Finally, something may be wrong with your MESA installation, so try recompiling it with
    <pre>
<kbd>cd $MESA_DIR</kbd>
<kbd>./clean</kbd>
<kbd>./install</kbd></pre>
  </li>
  <li>
    And if none of that works, try completely re-installing <samp>MESA</samp>
  </li>
</ul>
<h5>Running and Real-time Output</h5>
<p>
  Assuming that you have successfully compiled your work directory, start the simulation with <kbd>./rn</kbd>. Soon, terminal output should indicate that models are being computed. Note that you will want your terminal to be wide enough to fit each step's data without wrapping. Your terminal should be at least 146 columns wide for proper viewing.
</p>
<figure class='figure'>
  <img class='figure-img img img-fluid' src=./images/terminal_small.png alt="wrapped terminal output">
  <figcaption class='figure-caption'>
    Terminal output when the terminal is too small. The lines wrap and it becomes very difficult to interpret.
  </figcaption>
</figure>
<figure class='figure'>
  <img class='figure-img img img-fluid' src=./images/terminal_good.png alt="wrapped terminal output">
  <figcaption class='figure-caption'>
    Terminal output when the terminal is wide enough. Each chunk of three lines give summary data for each timestep. The headers are printed every few printed timesteps and guide you to the meaning of each number. In this figure, we indicated that the first row of the third column always gives the effective temperature in our stellar model.
  </figcaption>
</figure>

<p>
  These data can be helpful, but usually real-time plots from pgstar are a better way to understand how your stellar model is evolving. In order to see these plots, you'll need to properly configure your <code>pgstar</code> namelist (not covered here) and set <code>pgstar_flag = .true.</code> in your <code>star_job</code> namelist. If you have this set up, as in the standard work directory, plots (in this case a temperature-density profile as well as an HR diagram track) will appear in their own windows as the terminal output begins.
</p>
<h5>Restarting and Photos</h5>
<p>
  Sometimes you'll have to stop your simulation to adjust the inlist or because you need th computing power for some other task. You can do this by executing <kbd>ctrl-C</kbd>. But now do you have to restart the whole simulation? Fortunately, no! You can restart from a "photo". A photo is a snapshot of your stellar model dumped into a binary file.
</p>
<p>
  By default <samp>MESA</samp> saves a photo to the <code>photos</code> directory every 50 timesteps. They are named such that the last three digits are the same as the last three digits of their corresponding timestep. To save disk space, they are overwritten every thousand timesteps. That is, step 1050 will be saved as the file <code>x050</code> in <code>photos</code> (where the x is literally there), and it will be overwritten when step 2050 does the same thing. To give longer-term access, every thousand timesteps will remain indefinitely, so timesteps 1000 and 2000 will save photos <code>1000</code> and <code>2000</code>, respectively.
</p>
<p>
  To restart from photo <code>x050</code>, simply execute <kbd>./re x050</kbd>, assuming it exists in <code>photos</code>. <code>inlist</code> will be read again, so you can change commands on the fly, though in practice this is difficult to reproduce, so you should only use this workflow when you are prototyping a simulation.
</p>
<div class="card border-warning mb-3 text-warning">
  <div class="card-header bg-warning text-white">
    <h5 class='card-title mb-0'>Warning: Photo Pitfalls</h5>
  </div>
  <div class="card-body">
    <h5 class='card-text'><strong>Photos are not the same as saved models.</strong></h5>
    <p class="card-text"> 
      Photos are...
      <ul>
        <li>Binary (not readable by anything other than MESA)</li>
        <li>Sensitive to changes in the MESA source, so they will <strong>not</strong> work reliably on other versions of MESA</li>
        <li>A complete record of the star; it is the same as if the simulation had never been stopped</li>
      </ul>
      Saved models are...
      <ul>
        <li>Plain text and human-readable</li>
        <li>Robust to changes in the MESA source, and may be used on different revisions</li>
        <li>
          A mostly complete record, but you may notice small differences between a model that is restarted from a photo compared to one loaded from a model saved at the same timestep with the same inlist.
        </li>
      </ul>
    </p>
  </div>
</div>
<div class='buffer-small'></div>
<p>
  There's much more to learn about how to bend <samp>MESA</samp> to your will, including adding your own physics through code, but you know enough now to be dangerous. We'll touch on some more advanced techniques later.
</p>

<h2 id="part2" class='mt-5'> Part 2: Type I X-ray Bursts</h2>
<p>
  In this section we'll get our hands dirty by running a <samp>MESA</samp> simulation of a Type I X-ray burst. We'll start from a provided inlist and model, and then we'll edit that inlist to reproduce different burning regimes of accreting neutron stars, and finally we'll edit the microphysics used to calculate opacities in the extreme regimes present in neutron stars.
</p>
<p>
  You can find slides <a href="/projects/leiden_2019/xray_slides.pdf" download>here</a>, but the entire exercise is doable on this site alone.
</p>

<p>
  <span class="lead text-danger">Disclaimer:</span>
  The simulations you are going to do here in this part (and the next) are not resolved, use nuclear networks that are too small, and contain other shortcomings that make them quick to run, but not suitable for publication. 
</p>

<h4 id='part2a' class='mt-4'>A First X-ray Burst</h4>
<p>
  Rist, create a new <samp>MESA</samp> work directory somewhere in your local filesystem:
</p>
<p>
  <kbd>cp -r $MESA_DIR/star/work burst</kbd>
</p>
<p>
  and have a look inside. You should see the files described <a href="#part1a">above</a>. We will be replacing both <code>inlist_project</code> and <code>inlist_pgstar</code> to instead model an accreting netutron star and to display more pertinent on-screen plots than the defaults in the standard work directory's copy of <code>inlist_pgstar</code>. Additionally, we'll be adding in our own custom <code>history_columns.list</code> (review what that does <a href="#part1b">here</a>) to enable these plots, and a starting model, <code>ns_1.4M.mod</code>, which gives us just the outer regions of a neutron star above an iron substrate (the inner boundary condition is set to a fixed mass, radius, and luminosity).
</p>

<p>
  Download the new files with the link below:
</p>

<p class='text-center'>
  <a role=button class="btn btn-lg btn-primary" href='/projects/leiden_2019/burst.tgz' download>Get Burst Files</a>
</p>

<p>
  After downloading the file, unpack it inside the work directory:
</p>

<p>
  <kbd>tar -zxvf burst.tgz</kbd>
</p>

<p>
  This should create the four files mentioned above:
  <ul>
    <li><code>inlist_project</code></li>
    <li><code>inlist_pgstar</code></li>
    <li><code>history_columns.list</code></li>
    <li><code>ns_1.4.mod</code></li>
  </ul>
  You may be prompted to overwrite the two inlists. Go ahead and do that. Our custom <code>history_columns.list</code> will specifically allow us to track and plot the following contents:
  <ul>
    <li><code>star_age_hr</code>: this is the model's age in hours (the default is years, which is too long for our rapidly-bursting model</li>
    <li><code>max_eps_he_lgT</code>: the log of the temperature at the location of peak helium burning</li>
    <li><code>log_total_mass he4</code>: the log of the total mass of helium in the model (in M<sub>&#8857;</sub>)</li>
  </ul>
  Now you should compile and run the model:
</p>

<p>
  <kbd>./mk</kbd><br>
  <kbd>./rn</kbd>
</p>

<p>
  After some initial terminal output, you should see a pgstar (the plotting side of <samp>MESA</samp>) window popping up with multiple panels. The entire pgstar output, when strung into a movie, can be seen below.
</p>
<div align="center" class='embed-responsive embed-responsive-16by9 my-2'>
  <video controls fullscreen>
    <source src="first_burst.mp4" type="video/mp4">
    Your browser does not support the video tag.      
  </video>
</div>
<p>
  The upper left panel shows a density-temperature profile of the star, with the surface being on the lower-left (low temperature and density) and the inner-most part of the model in the upper right (high temperature and density). Note how regions of strong burning are indicated with background colors. In the lower left, we have the log of the surface luminosity (gold, left vertical axis) and the number of zones in the model (blue, right vertical axis) plotted as a function of time. Notice how the number of zones automatically increases during the first few bursts to better resolve the burning region. The upper right panel shows the elemental composition as a function of column depth, and the lower right panel shows how the temperature in the helium burning layer varies with the total mass of helium. 

</p>
<p>
  You'll see that this plot spirals in on a fixed point, coincident with the luminosity plot coming to a constant value after a few initial bursts. Evidently, we have found a stable burning solution, where the rate that helium is burned is nearly balanced by the rate it is accreted (though if you look closely, you'll see that the total amount of helium present slowly increases).
</p>
<p>
  If you let the simulation go to completion, it will stop after 3000 steps. What determines this? Try to figure out what controls this and other physical parameters in this simulation by studying <code>inlist_project.</code>
</p>

<p class='lead'>
  <span class='font-weight-bold'>Challenge:</span> Open <code>inlist_project</code> and identify the following pieces of information. 
  <ul>
    <li class='lead'>The stopping condition(s): there could be multiple, but at least one is after computing 3000 models</li>
    <li class='lead'>The nuclear network in use</li>
    <li class='lead'>The accretion rate</li>
  </ul>
</p>
<p class='lead'>
  You can learn more about available options in <code>$MESA_DIR/star/defaults/star_job.defaults</code> and <code>$MESA_DIR/star/defaults/star_job.defaults</code> or their online equivalanets for <a href="http://mesa.sourceforge.net/star_job_defaults.html" target=_blank>star_job</a> and <a href="http://mesa.sourceforge.net/controls_defaults.html" target=_blank>controls</a>.
</p>

<div class="card border-success mb-3">
  <div class="card-header bg-success text-white make-clickable">
    <button class="btn btn-link text-reset stretched-link" type="button" data-toggle="collapse" data-target="#inlist_project-sol" aria-expanded="true" aria-controls="inlist_project-sol">
      Show Solution
    </button>
  </div>
  <div class="card-body collapse" id="inlist_project-sol">
    <p class="card-text">
      There is only one stopping condition, which we already identified as a maximum model number of 3000. The line that sets it is in the controls namelist:
{% highlight fortran %}
      max_model_number = 3000
{% endhighlight %}
    </p> 
    <p>
      The nuclear reaction network is set in the <code>star_job</code> namelist by these lines:
{% highlight fortran %}
      change_initial_net = .true.      
      new_net_name = 'cno_extras_plus_fe56.net'
{% endhighlight %}
      The first line tells <samp>MESA</samp> that we want to change from the network in the starting model (even if we are "changing" to the same network), and the second line specifies what network to use. Premade networks can be found in <code>$MESA_DIR/data/net_data/nets</code>.
    </p>
    <p>
      The accretion rate of this model is 3 &#215; 10<sup>-8</sup> M<sub>&#8857;</sub>/yr, as set by the following line:
{% highlight fortran %}
      mass_change = 3e-8  ! rate of accretion (Msun/year)      
{% endhighlight %}
    </p>
    <p>
      You are encouraged to further explore what some of the other commands in this inlist are doing.
    </p>
  </div>
</div>

<h4 id='part2b' class='mt-4'>Burning Regimes</h4>
<p>
  It appears that accreting solar composition material at 3 &#215; 10<sup>-8</sup> M<sub>&#8857;</sub>/yr results in stable burning (though incomplete hydrogen burning implies that we don't have a large enough nuclear network). <a href="https://ui.adsabs.harvard.edu/abs/2004NuPhS.132..435C/abstract" target=_blank>Cumming (2004)</a> calculated these burning regimes and found the following rough boundaries.
</p>

<table class='table table-striped table-responsive table-hover my-5' id='burning-regimes'>
  <caption>
    Approximate burning regimes for accreting neutron stars. Note that <a href="https://ui.adsabs.harvard.edu/abs/2016MNRAS.456L..11K/abstract" target=_blank>Keek & Heger (2016)</a> find a new stable burning regime involving Carbon burning in a region where Helium burning is incomplete.
  </caption>
  <thead class='thead-dark'>
    <tr>
      <th class='text-nowrap'>Label</th><th class='text-nowrap'>Description</th><th class='text-nowrap'>Typical M&#775;</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td class='text-nowrap'>Stable</td>
      <td>Both H and He burning are thermally stable</td>
      <td class='text-nowrap'>10<sup>-8</sup> M<sub>&#8857;</sub>/yr</td>
    </tr>
    <tr>
      <td class='text-nowrap'>Mixed H/He</td>
      <td>Stable H burning (hot CNO cycle) but unstable He burning. He ignites in a H-rich environment (-> rp process)</td>
      <td class='text-nowrap'>10<sup>-9</sup> M<sub>&#8857;</sub>/yr</td>
    </tr>
    <tr>
      <td class='text-nowrap'>Pure He</td>
      <td>Stable H burning depletes all H before He ignites</td>
      <td class='text-nowrap'>10<sup>-10</sup> M<sub>&#8857;</sub>/yr</td>
    </tr>
    <tr>
      <td class='text-nowrap'>H-triggered</td>
      <td>Unstable H burning</td>
      <td class='text-nowrap'>10<sup>-11</sup> M<sub>&#8857;</sub>/yr</td>
    </tr>
  </tbody>
</table>

<div class='text-center'>
  <figure class='figure my-3'>
    <img class='figure-img img-fluid rounded' src='stability.png' alt='burning regimes as a function of temperature and column depth'>
    <figcaption class="figure-caption text-left">
      Profiles of accreting neutron stars in the different burning regimes as described by  <a href="https://ui.adsabs.harvard.edu/abs/2004NuPhS.132..435C/abstract" target=_blank>Cumming (2004)</a>
    </figcaption>
  </figure>
</div>
<p>
  Our goal is to try to reproduce these burning regime with our simple accreting neutron star model.
</p>

<p class='lead'>
  <span class='font-weight-bold'>Challenge:</span> Edit <code>inlist_project</code> to change the accretion rate, save, and rerun your model (no need to compile unless you change an actual fortran file). Determine what burning regime you are in.
</p>

<p>
  You may want to look at the last burst in your calculation in isolation. We provide a python script to do this, but it assumes you have numpy and matplotlib properply configured on your machine (should be the default with any reasonable scientific distribution of python like anaconda). To use it, <a href="/projects/leiden_2019/plot_lc.py" download>download it</a>, move it to your working directory, and execute <kbd>python plot_lc.py</kbd> after your run is over. Does your burst look like a Type I X-ray burst?
</p>

<div class="card border-success mb-3">
  <div class="card-header bg-success text-white make-clickable">
    <button class="btn btn-link text-reset stretched-link" type="button" data-toggle="collapse" data-target="#burning-regimes-sol" aria-expanded="true" aria-controls="burning-regimes-sol">
      Show Solution
    </button>
  </div>
  <div class="card-body collapse" id="burning-regimes-sol">
    <p class="card-text">
      Below are videos of four models run at the "typical M&#775;'s" from the table above.
    </p><
    <figure class='figure'>
      <div align="center" class='embed-responsive embed-responsive-16by9 my-2'>
        <video controls fullscreen>
          <source src="movie_mdot1e-08.mp4" type="video/mp4">
          Your browser does not support the video tag.      
        </video>
      </div>
      <figcaption class='figure-caption'>
        M&#775;=10<sup>-8</sup> M<sub>&#8857;</sub>/yr. Similar to our first burst, this goes through a few bursts that weaken until we reach a stable configuration.
      </figcaption>
    </figure>

    <figure class='figure'>
      <div align="center" class='embed-responsive embed-responsive-16by9 my-2'>
        <video controls fullscreen>
          <source src="movie_mdot1e-09.mp4" type="video/mp4">
          Your browser does not support the video tag.      
        </video>
      </div>
      <figcaption class='figure-caption'>
        M&#775;=10<sup>-9</sup> M<sub>&#8857;</sub>/yr. We get multiple bursts that seem to fall into a pattern, but then stop as helium builds up, and the run crashes on a large helium flash. Something's fishy here... Tentatively in the "Mixed H/He" range, as Hydrogen appears to burn steadily while He is going through bursts.
      </figcaption>
    </figure>
    <figure class='figure'>
      <div align="center" class='embed-responsive embed-responsive-16by9 my-2'>
        <video controls fullscreen>
          <source src="movie_mdot1e-10.mp4" type="video/mp4">
          Your browser does not support the video tag.      
        </video>
      </div>
      <figcaption class='figure-caption'>
        M&#775;=10<sup>-10</sup> M<sub>&#8857;</sub>/yr. Hydrogen burns steadily as a helium layer builds up. We don't actually get to the helium flash, but it is inevitable, so we are in the "Pure He" range.
      </figcaption>
    </figure>
    <figure class='figure'>
      <div align="center" class='embed-responsive embed-responsive-16by9 my-2'>
        <video controls fullscreen>
          <source src="movie_mdot1e-11.mp4" type="video/mp4">
          Your browser does not support the video tag.      
        </video>
      </div>
      <figcaption class='figure-caption'>
        M&#775;=10<sup>-11</sup> M<sub>&#8857;</sub>/yr. Now even Hydrogen burns unstably, as the layer builds up and burns away in a cyclic fashion. No He flash occurs in this video, but it would eventually ahpen after a large number of Hydrogen bursts.
      </figcaption>
    </figure>
  </div>
</div>

<h5>Missing Physics</h5>
<p>
  As we said in the disclaimer, these models are all missing some important physics. Here are just a few: 
</p>
<dl class='row'>
  <dt class='col-sm-3'>Mixed H/He Bursts</dt>
  <dd class="col-sm-9">We need a large network to follow the rp-process. Our model has a lot of leftover hydrogen, and low peak luminosities</dd>

  <dt class='col-sm-3'>Helium Flashes</dt>
  <dd class='col-sm-9'>These flashes reach Eddington luminosity. We need to be able to follow the expansion and wind. You will find that the code has toruble for low hydrogen fractions when the luminoisty approaches Eddington.</dd>

  <dt class='col-sm-3'>Hydrogen Flashes</dt>
  <dd class='col-sm-9'>
    These run smoothly, but at low accretion rates, we should include diffusion (there is a prescription in <samp>MESA</samp> for this).
  </dd>
</dl>

<h4 id='part2c' class='mt-4'>Extending MESA</h4>
Type I X-ray burst pose a challenge to opacity calculations because a complex mixture of elements is present that we cannot know in advance. <a href="https://ui.adsabs.harvard.edu/abs/1999ApJ...524.1014S/abstract" target=_blank>Schatz et al. (1999)</a> made an analytic fit to the free-free Gaunt factor from <a href="https://ui.adsabs.harvard.edu/abs/1991ApJ...382..636I/abstract" target=_blank>Itoh et al. (1991)</a>:

\[\kappa_{\mathrm{ff}} = 0.753 \mathrm{\frac{cm^2}{g}} \frac{\rho_5}{\mu_e T_8^{7/2}}\sum\frac{Z_i^2X_i}{A_i}g_{\mathrm{ff}}(Z_i,T,n_e)\]


<h2 id="part3" class='mt-5'>Part 3: Recurrent Novae</h2>
<p>
  In this section we'll learn a little about modeling recurrent novae in <samp>MESA</samp>. Along the way, we'll learn a few other useful skills and processes for working with <samp>MESA</samp>:
</p>
<ul>
  <li>Starting work from a test case</li>
  <li>Making movies from pgstar output</li>
  <li>Performing a convergence study</li>
  <li>Completing the implementation of an inlist control</li>
</ul>
<p>
  You can get the slides for this activity <a href="slides.pdf" download>here</a>, but this web site is a more detailed guide.
</p>
<h4 id="part3a" class='mt-4'>Background</h4>
<p>
  Recurrent novae are thermonuclear flashes on the surfaces of rapidly-accreting massive white dwarfs. They are similar to classical novae, but they have been observed in outburst multiple times. In general, the more massive a white dwarf is, the shorter the recurrence time will be. Similarly, the higher the accretion rate M&#775;, the shorter the recurrence time will be.
</p>

<p>
  There is a limit to how high M&#775; can be before the nova will find an equilibrium solution and burn material at the same rate it is accreted. There is some debate as to whether this could physically occur (perhaps the accretion doesn't return or is never stable enough over long enough timescales, etc.). For now, we will assume that accretion resumes immediately after the initial "explosion", and we will see that stable burning does occur for sufficiently high M&#775; in <samp>MESA</samp>. 
</p>
<p>
  Our goal is to find the transition M&#775; where this occurs, and we'll see that we need to be careful with our simulation if we want a consistent result.
</p>

<h4 id="part3b" class='mt-4'>Starting from a Test Case</h4>
<p>
  The test suites in <samp>MESA star</samp> and <samp>MESA binary</samp> help detect bugs in development by checking that the behavior of a known application doesn't change substantially as commits are made. They are also useful as starting points. We'll be using the <code>nova</code> test case as a basis for this exercise. Make a copy of it in your working area with 
</p>
<pre>
  <kbd>cp -r $MESA_DIR/star/test_suite/nova recurrent_nova</kbd>
</pre>
<p>
  Because this is a test case, we have to make a special change that we didn't have to when using the plain work directory. Namely, open up <code>make/makefile</code> and delete the line that sets <code>MESA_DIR</code>. If you don't do this, compilation will look in the wrong place for your installation.
</p>
<div class="card border-warning mb-3 text-warning">
  <div class="card-header bg-warning text-white">
    <h5 class='card-title mb-0'>Warning: Test Suite Pitfalls</h5>
  </div>
  <div class="card-body">
    <p class="card-text">
      When starting from a test case, <em>always</em> do the following:
    </p>
    <ul class="card-text">
      <li>
        Delete the <code>MESA_DIR = ../../../..</code> line in <code>make/makefile</code>
      </li>
      <li>
        Delete any lines that set <code>mesa_dir</code> in any inlists (typically in the main <code>inlist</code> file)
      </li>
      <li>
        Consider deleting the controls in inlists that limit the number of retries and backups, which are intended to help detect performance issues in testing.
      </li>
      <li>
        Look over code in <code>src/run_star_extras.f</code>. Many test cases implement special physics hooks or stopping conditions that you should know about.
      </li>
    </ul>
    <p class="card-text">
      In our case we'll be replacing the inlists, and we will tweak the custom stopping condition and continue using it.
    </p>
  </div>
</div>
<p>
  Next, open up <code>src/run_star_extras.f</code>. We won't analyze everything that's here (most is basically boilerplate code in every simulation). Note, though, the following lines near the top:

{% highlight fortran %}
integer :: num_bursts = 0
logical :: waiting_for_burst = .true.
real(dp) :: L_burst = 1d4, L_between = 1d3 ! Lsun units
{% endhighlight %}

  These variables are declared here and are used in <code>extras_check_model</code>:

{% highlight fortran %}
! returns either keep_going, retry, backup, or terminate.
integer function extras_check_model(id, id_extra)
   integer, intent(in) :: id, id_extra
   integer :: ierr
   type (star_info), pointer :: s
   ierr = 0
   call star_ptr(id, s, ierr)
   if (ierr /= 0) return
   include 'formats'
   extras_check_model = keep_going
   if (s% L_phot > L_burst) then
      if (waiting_for_burst) then
         num_bursts = num_bursts + 1
         write(*,2) 'num_bursts', num_bursts
         waiting_for_burst = .false.
      end if
   else if (s% L_phot < L_between) then
      if (num_bursts >= 1) then
         write(*,*) 'have finished burst'
         extras_check_model = terminate
         s% termination_code = t_extras_check_model
      end if
      waiting_for_burst = .true.
   end if
end function extras_check_model
{% endhighlight %}
Wherever you see <code>s%</code>, that is accessing data in the stellar model (<code>s</code> is called the "star info structure"; more on this later). Basically these controls then say that if we are waiting for a burst and the photometric luminosity exceeds 10<sup>4</sup> L<sub>&#8857;</sub>, then we have entered a burst, and when it then goes below 10<sup>3</sup> L<sub>&#8857;</sub>, we have finished the burst. After one such burst, the simulation is ended.
</p>

<p>
  We want to give the simulation two bursts to determine if it is "stable" rather than just one. Also, since the accretion rate is so rapid, sometimes the luminosity doesn't drop low enough between bursts to be counted as finishing the first burst, so we need to make some changes to this code.
</p>

<p class='lead'>
  <span class='font-weight-bold'>Challenge:</span> Edit <code>extras_check_model</code> so the simulation ends after two bursts rather than one.
</p>

<div class="card border-success mb-3">
  <div class="card-header bg-success text-white">
    <button class="btn btn-link text-reset" type="button" data-toggle="collapse" data-target="#num-burst-sol" aria-expanded="true" aria-controls="num-burst-sol">
      Show Solution
    </button>
  </div>
  <div class="card-body collapse" id="num-burst-sol">
    <p class="card-text">
      Edit the line
{% highlight fortran %}
      if (num_bursts >= 1) then
{% endhighlight %}      
    to
{% highlight fortran %}
      if (num_bursts >= 2) then
{% endhighlight %}
    </p> 
  </div>
</div>

<p class='lead'>
  <span class='font-weight-bold'>Challenge:</span> Edit <code>run_star_extras.f</code> so that a burst "ends" after the luminosity drops below 5 &#215; 10<sup>3</sup> L<sub>&#8857;</sub> instead of 1 &#215; 10<sup>3</sup> L<sub>&#8857;</sub>.
</p>

<div class="card border-success mb-3">
  <div class="card-header bg-success text-white">
    <button class="btn btn-link text-reset" type="button" data-toggle="collapse" data-target="#burst-def-sol" aria-expanded="true" aria-controls="burst-def-sol">
      Show Solution
    </button>
  </div>
  <div class="card-body collapse" id="burst-def-sol">
    <p class="card-text">
      Edit the line
{% highlight fortran %}
      real(dp) :: L_burst = 1d4, L_between = 1d3 ! Lsun units
{% endhighlight %}      
    to
{% highlight fortran %}
      real(dp) :: L_burst = 1d4, L_between = 5d3 ! Lsun units
{% endhighlight %}
    </p> 
  </div>
</div>

<p>
  Check that your solution still compiles by executing <kbd>./mk</kbd>.
</p>

<p>
  With your code working, let's replace the stock inlists with some tweaked ones prepared for this activity.
</p>

<div class='text-center'>
  <a href='/projects/leiden_2019/nova_tutorial.tar.gz' download>
    <button class='btn btn-primary btn-lg' type='button'>
      Download Files
    </button>
  </a>
</div>

<div class='buffer-tiny'></div>

<p>
  Untar these files into your work directory (<kbd>tar -xvzf ~/Downloads/nova_tutorial.tar.gz</kbd>, assuming you are in the work directory). They include a main inlist, as well as an updated version of <code>inlist_nova</code> as well as a separate inlist for plots. Finally, a replacement for <code>history_columns.list</code> is there to make it so certain quantities can be plotted on the on-screen plots.
</p>

<h2 id="part3c">Finding the Stability Boundary</h2>
<p>
  In <code>inlist_nova</code>, you'll notice the following lines

  {% highlight fortran %}
&controls

   !!!!!!!!!!!!!!!!!!!!!!!!!!!
   ! EDIT THIS SECTION FIRST !
   !!!!!!!!!!!!!!!!!!!!!!!!!!!

   ! MASS GAIN AND LOSS
      mass_change = ! your random value here!
  {% endhighlight %}

  Since we haven't set <code>mass_change</code> to any value, running the simulation will throw an ugly error. We need to pick a M&#775; to study. We'll crowd-source random values between 3.1 &#215; 10<sup>-7</sup> M<sub>&#8857;</sub>/yr and 3.7 &#215; 10<sup>-7</sup> M<sub>&#8857;</sub>/yr. Pick yours with the tool below:
</p>
<div class='text-center'>
  <div class="btn-group btn-group-lg" role="group" aria-label="Basic example">
    <button class="btn btn-primary" type="button" id="mdot-gen">Generate My M&#775;</button>
    <button type="button" class="btn btn-secondary btn-lg" disabled>
      <span class="text-dark">
        M&#775; = <span class='mdot-base'>??? </span> &#215; 10<sup> -7 </sup> M<sub>&#8857;</sub>/yr
      </span>
    </button>
  </div>
</div>
<div class='buffer-tiny'></div>
<p class='lead'>
  <span class='font-weight-bold'>Challenge:</span> Edit <code>inlist_nova</code> so that the model accretes matter at the right M&#775; you chose.
</p>

<div class="card border-success mb-3">
  <div class="card-header bg-success text-white">
    <button class="btn btn-link text-reset" type="button" data-toggle="collapse" data-target="#mass-change-sol" aria-expanded="true" aria-controls="mass-change-sol">
      Show Solution
    </button>
  </div>
  <div class="card-body collapse" id="mass-change-sol">
    <p class="card-text">
      Change the line above in <code>inlist_nova</code> to <code> mass_change = <span class="mdot-base">???</span>d-7</code>
    </p> 
  </div>
</div>

<p>
  With your M&#775; selected, you should be able to run your model. Compile with <kbd>./mk</kbd> if you haven't already, and then start the run with <kbd>./rn</kbd>. You should see some terminal output fly out, and then eventually a large pgstar dashboard should appear. If it's too large to fit on your screen, go into <code>inlist_pgstar</code> and reduce the value of <code>Grid1_win_width = 17</code> to something smaller.
</p>

<h4 class='mt-4'>Interpreting the pgstar Output</h4>
<p>
  There's a lot of data on your pgstar dashboard! In the upper left is a profile (snapshot of the entire star at one point) of the temperature and density of the star. Different colors indicate different mixing mechanisms or levels of nuclear burning as indicated by the legend. In the lower left is an HR diagram. The middle panel of plots show the last two years of history of various surface quantities, and the panel on the right shows profiles of the isotope abundances (top), nuclear energy generation (middle), and mixing mechanism diffusion coefficients (bottom). The very bottom shows text information that supplements the terminal output.
</p>

<p class='lead'>
  <span class='font-weight-bold'>Challenge:</span> Report whether or not your model was stable. If it was unstable, also report the following:
  <ul>
    <li>
      <strong>Recurrence Time:</strong> duration between successive starts of bursts
    </li>
    <li>
      <strong>SSS Duration</strong> duration in "supersoft phase" where hydrogen-burning luminosity is very close to the photospheric luminosity
    </li>
  </ul>
</p>

<div class="text-center mb-2">
  <a href="https://docs.google.com/spreadsheets/d/17UuB2cA5QniX65THA9VNQRNPgjXtiQTWQaO_2E0PZAQ/edit?usp=sharing" target=_blank>
    <button class='btn btn-lg btn-primary'>Record my Data</button>
  </a>
</div>

<div class="card border-primary mb-3">
  <div class="card-header bg-primary text-white">
    <button class="btn btn-link text-reset" type="button" data-toggle="collapse" data-target="#stability-hint" aria-expanded="true" aria-controls="stability-hint">
      Show Hint: Determining Stability
    </button>
  </div>
  <div class="card-body collapse" id="stability-hint">
    <p class="card-text">
      Here is a movie of a model that is clearly unstable:
    </p> 
    <div align="center" class='embed-responsive embed-responsive-16by9'>
      <video controls fullscreen>
        <source src="first_run_3.1.mp4" type="video/mp4">
        Your browser does not support the video tag.      
      </video>
    </div>
    <div class='buffer-tiny'></div>
    <p class="card-text">
      And here is a movie of a model that is clearly stable:
    </p> 
    <div align="center" class='embed-responsive embed-responsive-16by9'>
      <video controls fullscreen>
        <source src="first_run_3.7.mp4" type="video/mp4">
        Your browser does not support the video tag.      
      </video>
    </div>
  </div>
</div>

<div class="card border-primary mb-3">
  <div class="card-header bg-primary text-white">
    <button class="btn btn-link text-reset" type="button" data-toggle="collapse" data-target="#timescales-hint" aria-expanded="true" aria-controls="timescales-hint">
      Show Hint: Determining Timescales
    </button>
  </div>
  <div class="card-body collapse" id="timescales-hint">
    <p class="card-text">
      The beginnings of flashes are the easiest to identify, so estimate the time between the two subsequent sharp rises in the luminosity to get the recurrence time.
    </p> 
    <p>
      The SSS phase duration is a little more nebulous. Estimate the the duration from the time of minimum effective temperature until the photospheric and hydrogen-burning luminosities precipitously depart from each other as they plummet.
    </p>
    <div class='text-center'>
    <figure class='figure'>
      <img class="figure-img img-fluid rounded" alt='example timescales' src="timescales.png">
      <figcaption class="figure-caption text-left">Example estimates for the recurrence time and SSS duration for the M&#775;=3.1 &#215; 10<sup>-7</sup> M<sub>&#8857;</sub>/yr case. Here we estimate t<sub>recur</sub>=1.08 years and t<sub>SSS</sub>=0.26 yr.</figcaption>
    </figure>
    </div>
  </div>
</div>

<div class="card border-secondary mb-3">
  <div class="card-header bg-secondary">
    <h5 class='card-title mb-0'>Tool: Making Movies with <samp>images_to_movie</samp></h5>
  </div>
  <div class="card-body">
    <p class="card-text">
      Did you check out the hint about determining stability? The videos there were composed of all the output from pgstar. In this simulation, we output a snapshot of the pgstar output with each timestep into the <code>png</code> directory. Take a look in there, and you'll see a png for every timestep.
    </p> 
    <p class='card-text'>
      To make these into a movie, the SDK comes with a nifty script that does the heavy lifting for you: <code>images_to_movie</code>. To use it, do something like the following:
    </p>
    <p class='card-text text-center'>
      <kbd>images_to_move 'png/grid*.png' my_movie.mp4</kbd>
    </p>
    <p class='card-text'>
      This takes all files that match the pattern <code>nova_grid_*.png</code> in the png directory and then makes a movie by using each as a frame. The resulting movie is named <code>my_movie.mp4</code>.
    </p>
    <p class='card-text'>
      You can control how often pgstar outputs pngs, what they are named, and what directory they go into in the pgstar namelist.
    </p>
    <div class="card border-warning mb-2">
      <div class="card-header bg-warning text-white">
        <h5 class='card-title mb-0'>Warning: Stale png Directory</h5>
      </div>
      <div class="card-body text-warning">
        <p class="card-text">
          Before you start a new run, delete all files in <code>png</code> (<kbd>rm -f png/*.png</kbd>) or rename/move them. If you don't do this, you might end up with a mix of old and new files, and you won't know which is which.
        </p>
      </div>
    </div>
  </div>
</div>

<h4 id='part3d' class='mt-4'>Resolving the SSS Phase</h4>
<p>
  This simulation is tuned to run quickly, and as a result, the supersoft phase doesn't last many timesteps. If we ran through it too quickly, we might actually have missed stability, while shorter timesteps might catch it. Our goal now is to modify our simulation so that it takes shorter time steps, but only during the SSS phase.
</p>
<p>
  Fortunately, <samp>MESA</samp> has just the controls we want: <code>delta_HR_limit</code> and <code>delta_HR_hard_limit</code>. Both of these adjust the timestep based on how much the quantity
  \[\eta = \sqrt{\left[\log (L/L_\odot)\right]^2 + \left[\log T_{\mathrm{eff}}\right]^2}\]
  changes over the timestep. If &#951; is greater than <code>delta_HR_limit</code>, then the next timestep will be reduced by a factor of <code>delta_HR_limit</code>/&#951;. If instead &#951; is greater than <code>delta_HR_hard_limit</code>, the current timestep will be retried with a shorter timestep. 
</p>
<p>
  We could put these in our inlist, but they will make the entire run intolerably slow. We only want really high time resolution during the SSS phase, so we will implement this in <code>run_star_extras.f</code>, specifically, in <code>extras_check_model</code>, which is executed at the end of every timestep. We want to use these tight tolerances only when the hydrogen burning luminosity is similar to the photospheric luminosity. We also only really care when the effective temperature is large.
</p>
<div class="card border-secondary mb-3">
  <div class="card-header bg-secondary">
      <h5 class='card-title mb-0'>Accessing the star info structure</h5>
  </div>
  <div class="card-body">
    <p class='card-text'>
      Within subroutines in <code>run_star_extras</code>, we can access the full data in the stellar model via the "star info structure", which is usually denoted as <code>s</code>. All the data you can access are listed in <code>$MESA_DIR/star/public/star_data.inc</code>. Additionally, inlist controls are members of the star info structute, so all controls in <code>$MESA_DIR/star/defaults/controls.defaults</code> are can be accessed and changed.
    </p>    
    <p class='card-text'>
      Depending on when in the timestep you access the star info structure, some values will have already been set and/or any changes you make might be overwritten by another internal subroutine. Understanding what is set when and how often boils down to grepping around in <code>$MESA_DIR/star/private</code>. In <code>extras_check_model</code>, everything should already be set, so we don't yet need to worry about this detail (but anything we change won't affect this timestep!).
    </p>
    <p class='card-text'>
      To access a member of the star info structure, we just append a <code>%</code> after <code>s</code>, followed by the name. For instance, <code>s% mstar</code> will return the baryonic mass of the stellar model in grams. Note that units in the star info structure are <em>usually</em> in cgs (unless otherwise indicated in <code>$MESA_DIR/star/public/star_data.inc</code>), while inlist controls are often given in solar units, so you may need to juggle conversions between the two.
    </p>
  </div>
</div>

<p class='lead'>
  <span class='font-weight-bold'>Challenge:</span> Edit <code>extras_check_model</code> to add a conditional that sets <code>delta_HR_limit</code> to <code>5d-3</code> and <code>delta_HR_hard_limit</code> to <code>1d-2</code> whenever L<sub>H</sub>/L<sub>phot</sub> &lt; 1.1 <em>and</em> T<sub>eff</sub> &gt; 800,000 K <em>and</em> when the L<sub>phot</sub> is above the burst threshold set by <code>L_burst</code>. Otherwise both controls should be set to -1.
</p>
<div class="card border-primary mb-3">
  <div class="card-header bg-primary text-white">
    <button class="btn btn-link text-reset" type="button" data-toggle="collapse" data-target="#access-hint" aria-expanded="true" aria-controls="access-hint">
      Show Hint: Accessing the luminosities and effective temperature
    </button>
  </div>
  <div class="card-body collapse" id="access-hint">
    <p class='card-text'>
      You will want to use the following in your conditional:
      <ul>
        <li>
          <code>s% power_h_burn</code>: total power in L<sub>&#8857;</sub> produced by hydrogen burning
        </li>
        <li>
          <code>s% L_phot</code>: photospheric luminosity in L<sub>&#8857;</sub>
        </li>
        <li>
          <code>s% Teff</code>: effective temperature in Kelvin
        </li>
      </ul>
      Note that the <code>s%</code> means we are talking to the object that contains all the data about the stellar model, including physical quantities <em>and</em> inlist controls.
    </p>    
  </div>
</div>

<div class="card border-primary mb-3">
  <div class="card-header bg-primary text-white">
    <button class="btn btn-link text-reset" type="button" data-toggle="collapse" data-target="#setting-hint" aria-expanded="true" aria-controls="setting-hint">
      Show Hint: Setting Parameters on the Fly
    </button>
  </div>
  <div class="card-body collapse" id="setting-hint">
    <p class='card-text'>
      Use the following to set the timestep controls to the stricter limits:
    </p>
{% highlight fortran %}
  s% delta_HR_limit = 5d-3
  s% delta_HR_hard_limit = 1d-2
{% endhighlight %}
      <p>and the looser limits:</p>
{% highlight fortran %}
  s% delta_HR_limit = -1
  s% delta_HR_hard_limit = -1
{% endhighlight %}
  </div>
</div>
<div class="card border-success mb-3">
  <div class="card-header bg-success text-white">
    <button class="btn btn-link text-reset" type="button" data-toggle="collapse" data-target="#resolution-sol" aria-expanded="true" aria-controls="resolution-sol">
      Show Solution
    </button>
  </div>
  <div class="card-body collapse" id="resolution-sol">
    <p class="card-text">
      The main conditional in <code>extras_check_model</code> should now be something like this:
    </p> 
{% highlight fortran %}
  ! set defaults (no extra resolution)
  s% delta_HR_limit = -1
  s% delta_HR_hard_limit = -1

  if (s% L_phot > L_burst) then
     if (waiting_for_burst) then
        num_bursts = num_bursts + 1
        write(*,2) 'num_bursts', num_bursts
        waiting_for_burst = .false.
     end if
     ! if we are in SSS, add resolution
     if (s% power_h_burn / s% L_phot .LT. 1.1d0 .AND. s% Teff > 8d5) then
        s% delta_HR_limit = 5d-3
        s% delta_HR_hard_limit = 1d-2
     endif

  else if (s% L_phot < L_between) then
     if (num_bursts >= 2) then
        write(*,*) 'have finished burst'
        extras_check_model = terminate
        s% termination_code = t_extras_check_model
     end if
     waiting_for_burst = .true.
  end if
{% endhighlight %}
    <p class='card-text'>
      Note that the outer conditional takes care of the luminosity condition automatically.
    </p>
  </div>
</div>

<p class='lead'>
  <span class='font-weight-bold'>Challenge:</span> Recompile and rerun your model at the same M&#775;, but now with the increased time resolution. Report the same quantities as before, but now on the second tab of the google spreadsheet.
</p>
<div class="text-center mb-2">
  <a href="https://docs.google.com/spreadsheets/d/17UuB2cA5QniX65THA9VNQRNPgjXtiQTWQaO_2E0PZAQ/edit?usp=sharing" target=_blank>
    <button class='btn btn-lg btn-primary'>Record my Data (use second tab on bottom)</button>
  </a>
</div>

<h2 id='part3e' class='mt-4'>A New Wind Scheme</h2>
<p>
  The super eddington wind scheme we've been using for mass loss is simple and convenient, but you may have noticed that it continues well into the supersoft phase. In fact, this is largely due to the fact that we've moved the outer boundary condition to an optical depth of 20, which has the effect of making the model think it is super-eddington.
</p>
<p>
  Let's try replacing this wind scheme with the optically-thick wind model from <a href="https://ui.adsabs.harvard.edu/abs/1994ApJ...437..802K/abstract" target=_blank>Kato & Hachisu 1994</a>. They give a relatively simple law for the mass loss rate as a function of effective temperature:
  \[\log\left(\dot{M}/\mathrm{g/s}\right) = -1.49 \log\left(T_{\mathrm{eff}}/10^5\,\mathrm{K}\right) + b\]
  where <var>b</var> is a parameter that varies with the mass of the underlying white dwarf and is given by the table
</p>
<div class='row'>
  <div class='col-4 offset-4'>
  <table class='table table-striped table-hover table-sm table-responsive'>
    <caption>
      Nova wind parameters from <a href="https://ui.adsabs.harvard.edu/abs/1994ApJ...437..802K/abstract" target=_blank>Kato & Hachisu 1994</a>
    </caption>
    <thead class='thead-dark'>
      <tr>
        <th>Mass [M<sub>&#8857;</sub>]</th>
        <th><var>b</var></th>
      </tr>
    </thead>
    <tbody>
      <tr class='text-center'>
        <td>1.33</td>
        <td>20.78</td>
      </tr>
      <tr class='text-center'>
        <td>1.20</td>
        <td>20.72</td>
      </tr>
      <tr class='text-center'>
        <td>1.10</td>
        <td>20.67</td>
      </tr>
      <tr class='text-center'>
        <td>1.00</td>
        <td>20.62</td>
      </tr>
      <tr class='text-center'>
        <td>0.90</td>
        <td>20.55</td>
      </tr>
      <tr class='text-center'>
        <td>0.80</td>
        <td>20.49</td>
      </tr>
      <tr class='text-center'>
        <td>0.70</td>
        <td>20.38</td>
      </tr>
      <tr class='text-center'>
        <td>0.60</td>
        <td>20.24</td>
      </tr>
      <tr class='text-center'>
        <td>0.50</td>
        <td>20.01</td>
      </tr>
    </tbody>
  </table>
</div>
</div>
<p>
  This is implemented in <samp>MESA</samp> as the "nova" wind option. You can find the related controls in <code>$MESA_DIR/star/defaults/controls.defaults</code>.
</p>
<p class='lead'>
  <span class='font-weight-bold'>Challenge:</span> Edit <code>inlist_nova</code> [only] to deactivate the super eddington wind, and activate the nova wind. The nova wind should only be active for T<sub>eff</sub> &lt; 3 &#215; 10<sup>5</sup> K and L &gt; 10<sup>4</sup> L<sub>&#8857;</sub>. At a radius of 100 R<sub>&#8857;</sub>, set a Roche lobe overflow M&#775; of 10<sup>-3</sup> M<sub>&#8857;</sub>/yr.
</p>
<div class="card border-primary mb-3">
  <div class="card-header bg-primary text-white">
    <button class="btn btn-link text-reset" type="button" data-toggle="collapse" data-target="#deact-sewind-hint" aria-expanded="true" aria-controls="deact-sewind-hint">
      Show Hint: Deactivating the Super Eddington Wind
    </button>
  </div>
  <div class="card-body collapse" id="deact-sewind-hint">
    <p class="card-text">
      To shut off the super eddington winds, you can do one of two things to the <code>super_eddington_scaling_factor</code> control:
    </p>
    <ul>
      <li>Set it to 0 (instead of 1), which multiplies any calculated wind by 0.</li>
      <li>Comment out or delete the line. This will revert the value to its default, which is 0.</li>
    </ul>
  </div>
</div>
<div class="card border-primary mb-3">
  <div class="card-header bg-primary text-white">
    <button class="btn btn-link text-reset" type="button" data-toggle="collapse" data-target="#nova-wind-controls-hint" aria-expanded="true" aria-controls="nova-wind-controls-hint">
      Show Hint: Nova Wind Controls
    </button>
  </div>
  <div class="card-body collapse" id="nova-wind-controls-hint">
    <p class="card-text">
      You will need to set the following controls to appropriate values:
    </p>
    <ul>
      <li><code>nova_scaling_factor</code></li>
      <li><code>nova_wind_b</code></li>
      <li><code>nova_wind_max_Teff</code></li>
      <li><code>nova_wind_min_L</code></li>
      <li><code>nova_roche_lobe_radius</code></li>
      <li><code>nova_RLO_mdot</code></li>
    </ul>
    <p>You don't need to worry about <code>nova_min_Teff_for_accretion</code> yet, so don't set it.</p>
  </div>
</div>

<div class="card border-success mb-3">
  <div class="card-header bg-success text-white">
    <button class="btn btn-link text-reset" type="button" data-toggle="collapse" data-target="#nova-wind-sol" aria-expanded="true" aria-controls="nova-wind-sol">
      Show Solution
    </button>
  </div>
  <div class="card-body collapse" id="nova-wind-sol">
    <p class="card-text">
      Something like this should appear in your <code>controls</code> namelist:
{% highlight fortran %}
  ! parameter for mass loss driven by super Eddington luminosity. Final
  ! mdot is multiplied by this value, so 0 shuts wind off (default)
  super_eddington_scaling_factor = 0
  ! multiply Ledd by this factor when computing super Eddington wind
  ! e.g., if this is 2, then only get wind when L > 2*Ledd
  super_eddington_wind_Ledd_factor = 1

  nova_scaling_factor = 1 ! turn the wind on full blast
  nova_wind_b = 20.77 ! interpolated from table
  nova_wind_max_Teff = 3d5 ! don't calculate wind if hotter than this
  nova_wind_min_L = 1d4 ! don't calculate wind if less luminous than this
  nova_roche_lobe_radius = 1d2 ! at radii above this, use `nova_RLO_mdot`
  nova_RLO_mdot = 1d-3 ! mdot to use if radius is larger than roche_lobe_radius
{% endhighlight %}      
    You also could just delete the two lines about the super eddington wind.
    </p> 
  </div>
</div>
<p class='lead'>
  <span class='font-weight-bold'>Challenge:</span> Rerun your model at the same M&#775; as the first two times. Now it should use the nova wind prescription <em>and</em> have the higher time resolution in the SSS phase. Report the same quantities as before, but now on the third tab of the google spreadsheet.
</p>
<div class="text-center mb-2">
  <a href="https://docs.google.com/spreadsheets/d/17UuB2cA5QniX65THA9VNQRNPgjXtiQTWQaO_2E0PZAQ/edit?usp=sharing" target=_blank>
    <button class='btn btn-lg btn-primary'>Record my Data (use third tab on bottom)</button>
  </a>
</div>
<h2 id='part3f' class='mt-5'>Controlling Accretion</h2>
<p>
  In both wind prescriptions, if the model wasn't losing mass, it was gaining it. In reality, a nova eruption might disrupt its accretion disk or clear out a wind from a red giant donor. More practically (and less physically motivated), sometimes switching from mass gain in one timestep to mass loss in the next can create numerical difficulties. One solution is to have a buffer time in between mass loss and gain in which no mass change takes place.
</p>
<p>
  You may have noticed the <code>nova_min_Teff_for_accretion</code> control in the last challenge. The name of this control suggests that it might be just what we want!
</p>
<p class='lead'>
  <span class='font-weight-bold'>Challenge:</span> Use the <code>nova_min_Teff_for_accretion</code> control to shut off accretion when T<sub>eff</sub> &lt; 6 &#215; 10<sup>5</sup> K. Run the model and confirm that this worked by watching the history of M&#775; and T<sub>eff</sub> on the pgstar dashboard.
</p>
<div class="card border-success mb-3">
  <div class="card-header bg-success text-white">
    <button class="btn btn-link text-reset" type="button" data-toggle="collapse" data-target="#accretion-control-sol" aria-expanded="true" aria-controls="accretion-control-sol">
      Show Solution
    </button>
  </div>
  <div class="card-body collapse" id="accretion-control-sol">
    <p class="card-text">
      Something like this should appear in your <code>controls</code> namelist:
{% highlight fortran %}
  nova_min_Teff_for_accretion = 6d5
{% endhighlight %}      
    </p> 
  </div>
</div>
<p>
  Uh oh... that control didn't work, did it? The documentation in <code>$MESA_DIR/star/defaults/controls.defaults</code> tells us 
  <samp>When nova_scaling_factor /= 0 and Teff < this and L > nova_wind_min_L, no accretion.</samp> That sure <em>sounds</em> right, so what's going on? Have we found a bug?
</p>
<p>
  Let's take a look at the source to see where this control actually comes in to play. Most of the good sciency bits of code are found in <code>$MESA_DIR/star/private</code>. The functions and subroutines there aren't accessible to you in <code>run_star_extras.f</code>, but they can help you see how the sausage is made.
</p>
<p class='lead'>
  <span class='font-weight-bold'>Challenge:</span> Look in <code>$MESA_DIR/star/private</code> to find where <code>nova_min_Teff_for_accretion</code> is implemented.
</p>
<div class="card border-primary mb-3">
  <div class="card-header bg-primary text-white">
    <button class="btn btn-link text-reset" type="button" data-toggle="collapse" data-target="#grep-hint" aria-expanded="true" aria-controls="grep-hint">
     Show Hint: Searching in star/private
    </button>
  </div>
  <div class="card-body collapse" id="grep-hint">
    <p class="card-text">
      To search for "example" in all fortran (.f90) files in <code>$MESA_DIR/star/private</code>, try using <code>grep</code>:
    </p>
    <p>
      <kbd>cd $MESA_DIR/star/private</kbd><br>
      <kbd>grep "example" *.f90</kbd>
    </p>
  </div>
</div>
<div class="card border-success mb-3">
  <div class="card-header bg-success text-white">
    <button class="btn btn-link text-reset" type="button" data-toggle="collapse" data-target="#find-implementation-sol" aria-expanded="true" aria-controls="find-implementation-sol">
      Show Solution
    </button>
  </div>
  <div class="card-body collapse" id="find-implementation-sol">
    <p class="card-text">
      First, to find the relevant lines, we do <br>
      <kbd>cd $MESA_DIR/star/private</kbd><br>
      <kbd>grep "nova_min_Teff_for_accretion" *.f90</kbd>
    </p> 
    <p>
      We then get the following output (in mesa revision 11701):
      <pre><code>
ctrls_io.f90:    nova_scaling_factor, nova_wind_b, nova_wind_max_Teff, nova_wind_min_L, nova_min_Teff_for_accretion,&
ctrls_io.f90: s% nova_min_Teff_for_accretion = nova_min_Teff_for_accretion
ctrls_io.f90: nova_min_Teff_for_accretion = s% nova_min_Teff_for_accretion
star_controls.inc:         real(dp) :: nova_min_Teff_for_accretion, nova_roche_lobe_radius, nova_RLO_mdot
winds.f90:         !      T1 < s% nova_min_Teff_for_accretion .and. s% mass_change > 0) then        
      </code></pre>
    </p>
    <p>
      All but the last are code that just deal with defining and loading valid controls from namelists. So the implementation is in <code>winds.f90</code>. There we find that it's thrown away in a comment!
{% highlight fortran %}
!if (s% nova_scaling_factor /= 0 .and. L1/Lsun > s% nova_wind_min_L .and. &
!      T1 < s% nova_min_Teff_for_accretion .and. s% mass_change > 0) then
!   mdot = 0
!else
  mdot = eval_nova_wind(s, L1/Lsun, R1/Rsun, T1, ierr)
  if (ierr /= 0) then
     if (dbg .or. s% report_ierr) write(*, *) 'set_mdot: eval_nova_wind ierr'
     return
  end if
!end if
{% endhighlight %}      
    </p>
    <p>
      Perhaps you can see the problem. If <code>T1</code> (which here is the surface temperature) is less than the paramter, it will always set the change in the star's mass to be zero. That is, not only will mass gain be turned off, but <em><strong>so is our wind</strong></em>.
    </p>
  </div>
</div>
<p>
  So it looks like the original implementation of this control didn't really work as intended. (Aside: this was discovered, and the quick fix was to deactivate the control, but then the real fix has not yet been committed). So we're going to implement it!
</p>
<p>
  To implement this control, we'll use one of <samp>MESA</samp>'s "other" hooks, prototyped in <code>$MESA_DIR/star/other</code>. These files each allow you to drop some code into your <code>run_star_extras.f</code> that are injected into the evolution at runtime. The proper one to use here is <code>other_adjust_mdot</code>, which gives us the last word on mass gain or loss in the star (by ultimately setting <code>s% mstar_dot</code>).
</p>
<h4>Setting Up A Null Hook</h4>
<p>
  Before we implement this control, let's set up a hook into <samp>MESA</samp> that does nothing but print a statement out to the terminal so we know it's being called. Copy the <code>null_other_adjust_mdot</code> subroutine from <code>$MESA_DIR/star/other/other_adjust_mdot.f90</code> into <code>src/run_star_extras</code> in your local nova directory, right below <code>end subroutine extras_controls</code>. Rename the subroutine something more descriptive, like <code>nova_adjust_mdot</code> (be sure to update the name at the beginning and the end of the subroutine).
</p>
<p>
  Just because the subroutine is there doesn't mean it will be called when <samp>MESA</samp> is checking for the <code>other_adjust_mdot</code> hook. We need to edit <code>extras_conrols</code> to tell it that our new subroutine should be injected at that stage of evolution by adding
{% highlight fortran %}
  s% other_adjust_mdot => nova_adjust_mdot
{% endhighlight %}
</p>
<p>
  The two subroutines together should now look like this:
{% highlight fortran %}
      subroutine extras_controls(id, ierr)
         integer, intent(in) :: id
         integer, intent(out) :: ierr
         type (star_info), pointer :: s
         ierr = 0
         call star_ptr(id, s, ierr)
         if (ierr /= 0) return
         
         s% extras_startup => extras_startup
         s% extras_check_model => extras_check_model
         s% extras_finish_step => extras_finish_step
         s% extras_after_evolve => extras_after_evolve
         s% how_many_extra_history_columns => how_many_extra_history_columns
         s% data_for_extra_history_columns => data_for_extra_history_columns
         s% how_many_extra_profile_columns => how_many_extra_profile_columns
         s% data_for_extra_profile_columns => data_for_extra_profile_columns 

         ! YOU ADDED THIS LINE
         s% other_adjust_mdot => nova_adjust_mdot 
      end subroutine extras_controls

      subroutine nova_adjust_mdot(id, ierr)
         use star_def
         integer, intent(in) :: id
         integer, intent(out) :: ierr
         ierr = 0
      end subroutine nova_adjust_mdot
{% endhighlight %}
</p>
<p>
  Now let's add our write statement into <code>nova_adjust_mdot</code>, right after <code>ierr = 0</code>:
{% highlight fortran %}
      subroutine nova_adjust_mdot(id, ierr)
         use star_def
         integer, intent(in) :: id
         integer, intent(out) :: ierr
         ierr = 0
         write(*,*) "Hello from nova_adjust_mdot!"
      end subroutine nova_adjust_mdot
{% endhighlight %}
</p>
<p>
  Compile your code to make sure there aren't any syntax errors with <kbd>./mk</kbd>. Assuming things compiled fine, there's one last step you need to do to make <samp>MESA</samp> actually call our subroutine: add the line <code>use_other_adjust_mdot</code> to the <code>controls</code> namelist. After you've done that, run the simulation to see if your friendly message shows up at every timestep.
</p>
<figure class='figure'>
  <img src="hello_adjust.png" class='figure-img img-fluid rounded' alt='terminal output with adjust_mdot message'>
  <figcaption class='figure-caption'>
    Output with our pointless <code>other_adjust_mdot</code> properly working.
  </figcaption>
</figure>

<p>
  Now we are almost ready to do something interesting. Delete the write statement from your subroutine. We need to get access to the star info structure, which is the entity that lets us access and change physical details about the star. Each stellar model has an integer <code>id</code>. We can get the star info structure loaded by using this id, which is the main argument to our subroutine. You'll need to add two lines to your subroutine:
</p>
<ol>
  <li>
    <code>type (star_info), pointer :: s</code>: put this line before the <code>ierr = 0</code> line, since all declarations must come at the beginning of a subroutine; this line allocates space for the star info structure and names it <code>s</code>, which is a commong convention throughout <samp>MESA</samp>
  </li>
  <li>
    <code>call star_ptr(id, s, ierr)</code>: this conjures up the star info structure into <code>s</code> from the <code>id</code> provided in the signature to our subroutine. Now we can use <code>s</code> as a handle into our stellar model. Put it after <code>ierr = 0</code>
  </li>
</ol>
<p>
  Double check that your code compiles. If it does, now you're ready to actually implement this control!
</p>
<p class='lead'>
  <span class='font-weight-bold'>Challenge:</span> Finish the implementation of <code>nova_adjust_mdot</code>. Set <code>s% mstar_dot = 0d0</code> if <em>all</em> of the following conditions are met simultaneously:
</p>
<ul>
  <li class='lead'>
    Value set by <code>nova_scaling_factor</code> &gt; 0
  </li>
  <li class='lead'>
    Luminosity is above value set by <code>nova_wind_min_L</code>
  </li>
  <li class='lead'>
    Effective temperature is in between values set by <code>nova_wind_max_Teff</code> and <code>nova_min_Teff_for_accretion</code>
  </li>
</ul>
<p class='lead'>
  Otherwise, it should do nothing.
</p>
<div class="card border-primary mb-3">
  <div class="card-header bg-primary text-white">
    <button class="btn btn-link text-reset" type="button" data-toggle="collapse" data-target="#star-info-members-hint" aria-expanded="true" aria-controls="star-info-members-hint">
      Show Hint: Useful Members of the Star Info Structure
    </button>
  </div>
  <div class="card-body collapse" id="star-info-members-hint">
    <p class="card-text">
      You'll want to make use of the following members of the star info structure (that are just taken from the <code>controls</code> namelist):
    </p>
    <ul>
      <li><code>nova_scaling_factor</code></li>
      <li><code>nova_nova_wind_min_L</code> (note that this is in L<sub>&#8857;</sub>)</li>
      <li><code>nova_wind_max_Teff</code></li>
      <li><code>nova_min_Teff_for_accretion</code></li>
    </ul>
    <p>
      and the following from the model's physical data (found in <code>$MESA_DIR/star/public/star_data.inc</code>):
    </p>
    <ul>
      <li><code>mstar_dot</code></li>
      <li><code>Teff</code></li>
      <li><code>L_phot</code> (fortunately, this is <em>also</em> in L<sub>&#8857;</sub>, so we don't need to convert)</li>
    </ul>
  </div>
</div>

<div class="card border-success mb-3">
  <div class="card-header bg-success text-white">
    <button class="btn btn-link text-reset" type="button" data-toggle="collapse" data-target="#control-accretion-sol" aria-expanded="true" aria-controls="control-accretion-sol">
      Show Solution
    </button>
  </div>
  <div class="card-body collapse" id="control-accretion-sol">
    <p class="card-text">
      Your full implementation of <code>nova_adjust_mdot</code> should look something like this:
    </p>
{% highlight fortran %}
subroutine nova_adjust_mdot(id, ierr)
   use star_def
   integer, intent(in) :: id
   integer, intent(out) :: ierr
   type (star_info), pointer :: s

   ierr = 0
   call star_ptr(id, s, ierr)
   if (ierr /= 0) return

   if (s% nova_scaling_factor .GT. 0d0) then
      if (s% L_phot .GT. s% nova_wind_min_L .AND. &
         s% Teff > s% nova_wind_max_Teff .AND. &
         s% Teff < s% nova_min_Teff_for_accretion) then
         s% mstar_dot = 0d0
      endif
   endif
end subroutine nova_adjust_mdot
{% endhighlight %}
  </div>
</div>

<div class="card border-secondary mb-3">
  <div class="card-header bg-secondary">
      <h5 class='card-title mb-0'>Using Astrophysical Constants</h5>
  </div>
  <div class="card-body">
    <p class='card-text'>
      We didn't need to worry about this in this exercise, but often quantities are stored in the star info structure in cgs, but relevant controls (and indeed some of the internal values in the star info structure) are expressed in solar units. Converting between these (and many other tasks) are made easy by the <samp>const</samp> module, whidh is loaded at the top of your <code>run_star_extras.f</code> file:
    </p>    
{% highlight fortran %}
      use star_lib
      use star_def
      use const_def ! loads all sorts of goodies
{% endhighlight %}
    <p class='card-text'>
      Look in <code>$MESA_DIR/const/public/const_def.f90</code> to see what constants are already available. So long as the module is loaded, you don't need to declare these or anything before using them, and they aren't part of the star info structure, so you could just reference <code>Lsun</code> directly in any of the code, and it will evaluate to a solar luminosity in cgs.
    </p>
  </div>
</div>


<p class='lead'>
  <span class='font-weight-bold'>Challenge:</span> Rerun your model at the same M&#775; as the first three times. Now it should use the nova wind prescription with the higher time resolution in the SSS phase <em>and</em> accretion should stop before mass loss begins (if it ever begins). Report the same quantities as before, but now on the fourth tab of the google spreadsheet.
</p>
<div class="text-center mb-2">
  <a href="https://docs.google.com/spreadsheets/d/17UuB2cA5QniX65THA9VNQRNPgjXtiQTWQaO_2E0PZAQ/edit?usp=sharing" target=_blank>
    <button class='btn btn-lg btn-primary'>Record my Data (use fourth tab on bottom)</button>
  </a>
</div>
<h4> Discussion </h4>
<p>You should find that mass loss doesn't even occur anymore; simply stopping accretion halts the redward surge before the nova wind can begin. As a result, recurrence times and SSS phase durations should increase. You could simulate different scenarios where accretion resumes at later and later times by increasing <code>nova_min_Teff_for_accretion</code>, perhaps even setting it to something ludicrously high, like 10<sup>7</sup> K, so that no accretion ever happens during the SSS phase. In this case, we wouldn't expect there to be <em>any</em> M&#775; with stable burning (what <a href="https://ui.adsabs.harvard.edu/abs/2016ApJ...824...22H/abstract" target=_blank>Kato & Hachisu call "enforced novae"</a>).
</p>
<p>
  The super eddington wind prescription, in additon to being poorly resolved in time, suffered from mass loss continuing well into the SSS phase, which if we dug deeper, we would realize would not happen had we not set our surface boundary condition at &tau;=30. We still haven't touched on what changing the spatial resolution would do, or more importantly how convective boundary mixing during the runaway would change things. There are still many experiments to run!
</p>
